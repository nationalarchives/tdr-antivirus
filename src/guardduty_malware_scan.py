import time
import os


def get_object_tagging(s3_client, bucket, object_key):
    return s3_client.get_object_tagging(
        Bucket=f'{bucket}',
        Key=f'{object_key}'
    )['TagSet']


def poll_guard_duty_scan_complete(s3_client, bucket, object_key):
    await_delay_secs = os.getenv('POLL_MALWARE_SCAN_COMPLETE_AWAIT_SECS', 5)
    while True:
        tag_set = get_object_tagging(s3_client, bucket, object_key)
        for tag in tag_set:
            tag_key = tag['Key']
            if tag_key == 'GuardDutyMalwareScanStatus':
                scan_result = tag['Value']
                return scan_result
        time.sleep(await_delay_secs)


def guard_duty_threat_found(s3_client, bucket, object_key):
    scan_result = poll_guard_duty_scan_complete(s3_client, bucket, object_key)
    threats = []
    if scan_result == 'THREATS_FOUND':
        threats = ["awsGuardDutyThreatFound"]
    return threats
