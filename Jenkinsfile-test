library("tdr-jenkinslib")

def repo = "tdr-antivirus"
def versionTag = "v${env.BUILD_NUMBER}"
def yaraVersion = "4.1.0"

pipeline {
  agent {
    label "master"
  }
  stages {
    stage("Run git secrets") {
      steps {
        script {
          tdr.runGitSecrets(repo)
        }
      }
    }
    stage('Run tests') {
      agent {
        ecs {
          inheritFrom "aws"
          taskrole "arn:aws:iam::${env.MANAGEMENT_ACCOUNT}:role/TDRJenkinsNodeLambdaRoleIntg"
        }
      }
      steps {
        script {
          sh "pip install -r requirements.txt"
          sh "python -m pytest"
        }
      }
    }

    stage("Deploy to integration") {
      when {
        beforeAgent true
        expression { env.BRANCH_NAME == "master"}
      }
      stages {
        stage("Build zip file") {
          steps {
            script {
              sshagent(['github-jenkins']) {
                sh("git clone --branch master git@github.com:nationalarchives/tdr-configurations.git")
              }
              sh "docker build -f Dockerfile-yara --pull --no-cache --build-arg YARA_VERSION=${yaraVersion} -t yara ."
              sh "docker build -f Dockerfile-dependencies --pull --no-cache --build-arg YARA_VERSION=${yaraVersion} -t yara-dependencies ."
              sh "docker build -f Dockerfile-compile --no-cache -t yara-rules ."
              sh "docker run -itd --rm --name dependencies yara-dependencies"
              sh "docker cp dependencies:/lambda/dependencies.zip ."
              sh "docker run -itd --rm --name rules yara-rules"
              sh "mkdir lambda"
              sh "docker cp rules:/rules/output ./lambda"
              sh "unzip -q dependencies.zip -d ./lambda"
              sh "cp src/matcher.py ./lambda"
              dir("lambda") {
                sh "zip -r9 function.zip ."
                stash includes: "function.zip", name: "function.zip"
              }
            }
          }
        }
        stage("Upload function") {
          when {
            beforeAgent true
            expression { env.BRANCH_NAME == "master"}
          }
          agent {
            ecs {
              inheritFrom "aws"
              taskrole "arn:aws:iam::${env.MANAGEMENT_ACCOUNT}:role/TDRJenkinsNodeLambdaRoleIntg"
            }
          }
          steps {
            script {
              unstash "function.zip"
              sh "aws s3 cp function.zip s3://tdr-backend-code-mgmt/${versionTag}/yara-av.zip"

              tdr.configureJenkinsGitUser()

              sh "git tag ${versionTag}"
              sshagent(['github-jenkins']) {
                sh("git push origin ${versionTag}")
              }

              build(
                  job: "TDR Antivirus Deploy",
                  parameters: [
                      string(name: "STAGE", value: "intg"),
                      string(name: "TO_DEPLOY", value: versionTag)
                  ],
                  wait: false)
            }
          }
        }
      }

    }
  }
  post {
    failure {
      script {
        tdr.reportFailedBuildToGitHub(repo, env.GIT_COMMIT)
      }
    }
    success {
      script {
        tdr.reportSuccessfulBuildToGitHub(repo, env.GIT_COMMIT)
      }
    }
    always {
      script {
        sh "docker stop dependencies | true"
        sh "docker stop rules | true"
      }
    }
  }
}
